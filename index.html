<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script type="text/javascript" src="jquery-1.9.0.min.js"></script>

<style>

    :root {
        /*--main-color: #7597ce;*/
        --main-color: #0699fa;
    }
    
    #bound {
        width: 1024px;
        height: auto;
        margin: 0px auto;
        text-align: left;
        background-color:#fff;
        
        padding:30px;
        margin-top:0px;
    }

    body {
        background-color:#eee;
        font-family:"Ubuntu Light";
        font-size: 18px;
        padding:0px;
        margin:0px;
    }
    
    h1 { 
        color: var(--main-color);
    }
    
    h3 { 
        color: var(--main-color);
        margin:0px;
    }
    
    a {
        text-decoration: none;
        color: var(--main-color);
    }

    a:hover {
        text-decoration: none;
        color: var(--main-color);
    }
    
    hr {
        background: var(--main-color);
        border: 0; height: 1px;
    }
        
    .table {
    }
    
    td {
        padding-right:20px;
        font-family:"Ubuntu Light";
        font-size: 16px;
    }

    input[type="text"] {
        padding:3px;
        font-family:"Ubuntu Light";
        font-size: 16px;
        color: var(--main-color);
        width:80px;

    }
    
    button {
        padding:10px;
        font-family:"Ubuntu Light";
        font-size: 16px;
        width:100px;
    }

    span {
        color: var(--main-color);
    }
    
    #header-bound {
        background-color:#dedede;
        color:#333;
        font-size:12px;
        width: 1074px;
        height: auto;
        margin: 0px auto;
        text-align: left;
        margin-top:0px;
        padding:5px;
    }
}
</style>

<body>

<div id="header-bound">
This model is open source, view the source code and learn how it works on github: <a href="https://github.com/TrystanLea/energymodel/tree/model3">https://github.com/TrystanLea/energymodel/tree/model3</a>.
Comment on the model and see what further development is planned <a href="http://zcb.wikispot.org/OpensourceEnergyModel">here</a>.
You can also download the full ten year hourly model used for ZCB <a href="https://dl.dropboxusercontent.com/u/79311585/ZCB_TYHME_v2.xlsx">here</a>.
</div>

<div id="bound">

<h1>ZERO CARBON ENERGY MODEL</h1>
<p>Hourly zero carbon energy model for the UK.</p>

<div style="overflow: scroll; overflow-y: hidden;">
<canvas id="graph" width="8760" height=250"></canvas>

</div>
<br>
<button id="balance">Balance</button>
<button id="supply">Supply</button>
<button id="demand">Demand</button>
<button id="store">Store</button>
<button class="run">Run</button>


<hr><h3>SUPPLY</h3><hr>

<table style="width:100%">

    <tr>
        <th style="text-align:left">Supply</th><th></th>
    </tr>
    <tr><td>GW</td></tr>
    <tr>
        <td>Onshore wind</td><td><input type="text" key="input.onshore_wind_capacity"></td>        
        <td>Solar</td><td><input type="text" key="input.solar_capacity"></td>
        <td>Wave</td><td><input type="text" key="input.wave_capacity"></td>
              
    </tr>
    <tr>
        <td>Offshore wind</td><td><input type="text" key="input.offshore_wind_capacity"></td>
        <td>Hydro</td><td><input type="text" key="input.hydroCap"></td>
        <td>Tidal</td><td><input type="text" key="input.tidal_capacity"></td>
        
    </tr>
    <tr>
        <td>Geothermal heat</td><td><input type="text" key="input.geothermal_heat_capacity"></td>
        <td>Solar thermal</td><td><input type="text" key="input.solarthermal_capacity"></td>
        <td>Nuclear</td><td><input type="text" key="input.nuclear_capacity"></td> 
        <td></td><td></td>
    </tr>
    <tr><td>Backup capacity</td><td><input type="text" key="input.backupCap"></td></tr>
    <tr><td><BR></td></tr>
    <tr><td>Biomass</td><td><input type="text" key="input.total_biomass_produced"></td><td>TWh/yr</td></tr>
    <tr><td><BR></td></tr>
    </table>
    
    <hr><h3>APPLIANCES, LIGHTING & COOKING</h3><hr>
    <table>
    <tr><td>Electricity</td><td>Solid</td><td>Gas</td><td>Liquid</td></tr>
    <tr>
        <td><input type="text" key="input.appliancesDemand_TWh"></td>
        <td><input type="text" key="input.appliancesSolidDemand"></td><td><input type="text" key="input.appliancesGasDemand"></td>
        <td><input type="text" key="input.appliancesLiquidDemand"></td><td> all TWh/yr</td>
    </tr>
    </table>
    
    <hr><h3>HEATING</h3><hr>
    <table>
    <tr>  
        <td>Number of buildings (millions)</td><td><input type="text" key="input.number_of_buildings"></td>
        <td>Average heat loss rate</td><td><input type="text" key="input.average_heatloss_WK"> W/K</td>
        <td>Total heat loss rate</td><td><span key="out.heatLossCoefficient" scale=1 dp=1></span></td><td>GW/Â°C</td>
    </tr>
    <tr>
        <td>Hot water (heat)</td><td><input type="text" key="input.hotWaterDemand_TWh"></td><td>TWh/yr</td>
    </tr>
    </table>
    <br>
    <table>
    <tr>
        <td></td><td>Direct electric</td><td>Heat pumps</td><td>Solid</td><td>Gas</td><td>Liquid</td><td>CHP(s)</td><td>CHP(g)</td><td>CHP(l)</td>
        <tr>    
        <td>% heat demand met by...</td><td><input type="text" key="input.percentHeatDirectelec"></td><td><input type="text" key="input.percentHeatHeatpumps"></td>
        <td><input type="text" key="input.percentHeatSolid"></td><td><input type="text" key="input.percentHeatGas"></td>
        <td><input type="text" key="input.percentHeatLiquid"></td><td><input type="text" key="input.percentHeatCHPSolid"></td>
        <td><input type="text" key="input.percentHeatCHPGas"></td><td><input type="text" key="input.percentHeatCHPLiquid"></td>
        </tr>
    </tr>
    <tr>  
        <td>Heatpump COP</td><td></td><td><input type="text" key="input.hourly_heatpump_COP"></td>
        <td></td><td></td>
        <td></td><td></td>
    </tr>
    </table>
    
    <hr><h3>TRANSPORT</h3><hr>
    <table>
    <tr>
        <th style="text-align:left">Electric trains</th><th></th>
        <th style="text-align:left">Electric vehicles</th><th></th>
        <th style="text-align:left">Hydrogen vehicles</th><th></th>
    </tr><tr>
        <td>Number of passengers (million)</td><td><input type="text" key="input.electrains_passengers"></td>
        <td>Number of vehicles (million)</td><td><input type="text" key="input.elecvehicles_number"></td>  
        <td>Number of vehicles (million)</td><td><input type="text" key="input.hydrogenvehicles_number"></td>    
    </tr><tr>
        <td>Average annual train miles</td><td><input type="text" key="input.electrains_miles"></td>
        <td>Average annual miles driven</td><td><input type="text" key="input.elecvehicles_miles_driven"></td>
        <td>Average annual miles driven</td><td><input type="text" key="input.hydrogenvehicles_miles_driven"></td>
    </tr><tr>
        <td>Average kwh per 100 p-km</td><td><input type="text" key="input.electrains_performance"></td>
        <td>Average miles per kWh</td><td><input type="text" key="input.elecvehicles_miles_per_kwh"></td>
        <td>Average miles per kWh</td><td><input type="text" key="input.hydrogenvehicles_miles_per_kwh"></td>
    </tr><tr>
        <td>Electric train energy demand:</td><td><span key="out.electrains_energy_demand" scale=1 dp=1></span> TWh/yr</td>
        <td>Electric vehicle energy demand:</td><td><span key="out.elecvehicles_energy_demand" scale=1 dp=1></span> TWh/yr</p></td>
        <td>Hydrogen energy demand:</td><td><span key="out.hydrogenvehicles_H2_energy_demand" scale=1 dp=1></span> TWh/yr</p></td>
    </tr><tr>
        <th><br></th><th></th>
        <th><br></th><th></th>
        <th><br></th><th></th>
    </tr><tr>
        <th style="text-align:left">Biofuel aircraft</th><th></th>
        <th style="text-align:left">Biofuel vehicles</th><th></th>
        <th style="text-align:left">Other</th><th></th>
    </tr><tr>
        <td>Number of passengers (million)</td><td><input type="text" key="input.biofuelaircraft_passengers"></td>
        <td>Number of vehicles (million)</td><td><input type="text" key="input.biofuelvehicles_number"></td>  
        <td>Transport solid demand</td><td><input type="text" key="input.transportSolidDemand"></td></td>    
    </tr><tr>
        <td>Average annual air miles</td><td><input type="text" key="input.biofuelaircraft_miles"></td>
        <td>Average annual miles driven</td><td><input type="text" key="input.biofuelvehicles_miles"></td>
        <td>Transport gas demand</td><td><input type="text" key="input.transportGasDemand"></td></td>  
    </tr><tr>
        <td>Average kwh per 100 p-km</td><td><input type="text" key="input.biofuelaircraft_performance"></td>
        <td>Average miles per kWh</td><td><input type="text" key="input.biofuelvehicles_miles_per_kwh"></td>
        <td>Transport liquid demand</td><td><input type="text" key="input.other_transportLiquidDemand"></td></td>  
    </tr><tr>
        <td>Biofuel aircraft energy demand:</td><td><span key="out.biofuelaircraft_energy_demand" scale=1 dp=1></span> TWh/yr</td>
        <td>Electric vehicle energy demand:</td><td><span key="out.biofuelvehicles_energy_demand" scale=1 dp=1></span> TWh/yr</p></td>
        <td></td><td></td>
    </tr>
    </table>
    
    <hr><h3>INDUSTRY</h3><hr>
    <table>
        <tr><td>Electricity</td><td>Solid</td><td>Gas</td><td>Liquid</td><td>CHP(s)</td><td>CHP(g)</td><td>CHP(l)</td><td>Hydrogen</td></tr>
        <tr>
        <td><input type="text" key="input.industryDemand_TWh"></td>
        <td><input type="text" key="input.industrySolidDemand"></td><td><input type="text" key="input.industryGasDemand"></td>
        <td><input type="text" key="input.industryLiquidDemand"></td><td><input type="text" key="input.industryCHPSolidDemand"></td>
        <td><input type="text" key="input.industryCHPGasDemand"></td><td><input type="text" key="input.industryCHPLiquidDemand"></td>
        <td><input type="text" key="input.industryHydrogenDemand"></td><td> all TWh/yr</td>
    </tr>
    </table>
    
    <hr><h3>ELECTRIC STORE</h3><hr>
    <table>

    <tr>
        <td COLSPAN=2>Store max discharge rate (GW)</td><td><input type="text" key="input.elecstore_max_discharge_rate"></td>    
        <td COLSPAN=2>Store max charge rate (GW)</td><td><input type="text" key="input.elecstore_max_charge_rate"></td>
        <td COLSPAN=2>Store max capacity (GWh)</td><td><input type="text" key="input.elecstore_capacity"></td>
    </tr>
    <tr>
        <td COLSPAN=2>Store discharge efficiency</td><td><input type="text" key="input.elecstore_discharge_efficiency"></td>
        <td COLSPAN=2>Store charge efficiency</td><td><input type="text" key="input.elecstore_charge_efficiency"></td>
        <td COLSPAN=2>Store start capacity (GWh)</td><td><input type="text" key="input.elecstore_start_capacity"></td>
    </tr>
    </table>
    
    <hr><h3>HYDROGEN, SYNTHETIC FUEL AND METHANE</h3><hr>
    <table>
        <tr>
            <td COLSPAN=2>Electrolysis capacity</td><td><input type="text" key="input.electrolysisCap"></td><td>GW</td>
            <td COLSPAN=3>Use hydrogen for synthetic fuels</td>
            <td><select type = "text" key="input.useH2ForSynthFuels">
                <option value="1" selected>Yes</option>
                <option value="0">No</option>
                </select>
            </td>
        </tr>
        <tr>
            <td COLSPAN=2>Hydrogen store capacity</td><td><input type="text" key="input.hydrogen_store_capacity"></td><td>GWh</td>
        </tr>
        <tr>
            <td COLSPAN=2>Liquid store capacity</td><td><input type="text" key="input.synthfuel_store_capacity"></td><td>GWh</td>
        </tr>
        <tr>
            <td COLSPAN=2>Gas store capacity</td><td><input type="text" key="input.methane_store_capacity"></td><td>GWh</td>
        </tr>
    </table>

<br>
<button class="run">Run</button>
<hr><h3>OUTPUT</h3><hr>
<table style="width:100%">


    <tr>
        <th style="text-align:left">Supply</th><th></th>
        <th style="text-align:left">Demand</th><th></th>
        <th style="text-align:left">Store</th><th></th>
    </tr>

    <tr>
        <td>Offshore wind</td><td><span key="out.offshore_wind_generation_total" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Total heat demand</td><td><span key="out.totalHeatDemand" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Max discharge rate</td><td><span key="out.elecstore_used_discharge_rate" dp=1></span> GW</td>
    </tr>

    <tr>
        <td>Onshore wind</td><td><span key="out.onshore_wind_generation_total" scale=0.001 dp=1></span> TWh/yr</td>
        <td></td><td></td>
        <td>Max charge rate</td><td><span key="out.elecstore_used_charge_rate" dp=1></span> GW</td>
    </tr>
    
    <tr>
        <td>Solar</td><td><span key="out.solar_generation_total" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Total electricity demand</td><td><span key="out.total_electricity_demand" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Lowest capacity</td><td><span key="out.elecstore_used_min_capacity" dp=1></span> GWh</td>
    </tr>
    
    <tr>
        <td>Hydro</td><td><span key="out.hydro_generation_total" scale=0.001 dp=1></span> TWh/yr</td>
        <td></td><td></td>
        <td>Highest capacity</td><td><span key="out.elecstore_used_max_capacity" dp=1></span> GWh</td>
    </tr>
    
    <tr>
        <td>Wave</td><td><span key="out.wave_generation_total" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Unmet electricity demand</td><td><span key="out.unmet_electricity_demand" scale=0.001 dp=1></span> TWh/yr</td>    
        <td>Total charge</td><td><span key="out.elecstore_total_charge" scale=0.001 dp=1></span> TWh</td>
    </tr>
    
    <tr>
        <td>Tidal</td><td><span key="out.tidal_generation_total" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Max shortfall</td><td><span key="out.max_shortfall" dp=1></span> GW</td>
        <td>Total discharge</td><td><span key="out.elecstore_total_discharge" scale=0.001 dp=1></span> TWh</td>
    </tr>
    
    <tr>
        <td>Nuclear</td><td><span key="out.nuclear_generation_total" scale=0.001 dp=1></span> TWh/yr</td>
        <td></td><td></td>
        <td>Total loss</td><td><span key="out.elecstore_total_loss" scale=0.001 dp=1></span> TWh</td>
    </tr>
    
    <tr>
        <td>Excess generation</td><td><span key="out.excess_electricity_generation" scale=0.001 dp=1></span> TWh/yr</td>
        <td></td><td></td>
        <td>End capacity level</td><td><span key="out.elecstore_capacity" dp=1></span> GWh</td>        
    </tr>
    
    <tr>
        <td>Backup generation</td><td><span key="out.backupGeneration" scale=0.001 dp=1></span> TWh/yr</td>
        <td></td><td></td>
        <td></td><td></td>        
    </tr>
    
    <tr>
        <td>Backup capacity used</td><td><span key="out.backupCapUsed" dp=1></span> GW</td>
        <td></td><td></td>
        <td></td><td></td>        
    </tr>
    
    <tr><td><BR></td></tr>

    <tr>
        <td>Hydrogen produced</td><td><span key="out.total_hydrogen_produced" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Hydrogen demand</td><td><span key="out.total_hydrogen_demand" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Unmet hydrogen demand</td><td><span key="out.unmet_hydrogen_demand" scale=0.001 dp=1></span> TWh/yr</td>
    </tr>    
    <tr>
        <td>Biomass produced</td><td><span key="out.total_biomass_produced" scale=1 dp=1></span> TWh/yr</td>
        <td>Solid fuel demand</td><td><span key="out.total_solid_demand" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Solid fuel surplus</td><td><span key="out.biomass_surplus" scale=0.001 dp=1></span> TWh/yr</td>
    </tr>
    <tr>
        <td></td><td></td> 
        <td></td><td></td> 
        <td>Unmet solid demand</td><td><span key="out.unmet_solid_demand" scale=0.001 dp=1></span> TWh/yr</td>
    </tr>
    <tr>
        <td>Biogas/synthetic gas</td><td><span key="out.total_gas_produced" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Gas fuel demand</td><td><span key="out.total_gas_demand" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Unmet gas demand</td><td><span key="out.unmet_gas_demand" scale=0.001 dp=1></span> TWh/yr</td>
    </tr>
    <tr>
        <td>Biofuel/synthetic liquid</td><td><span key="out.total_liquid_produced" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Liquid fuel demand</td><td><span key="out.total_liquid_demand" scale=0.001 dp=1></span> TWh/yr</td>
        <td>Unmet liquid demand</td><td><span key="out.unmet_liquid_demand" scale=0.001 dp=1></span> TWh/yr</td>
    </tr>
    <tr><td><BR></td></tr>
    <tr>
        <td><h3>Residual Emissions</td><td><span key="out.residual_emissions" scale=0.001 dp=1></span> MtCO2/yr</h3></td>
        <td></td><td></td>
        <td></td><td></td>        
    </tr>
    <tr><td><BR></td></tr>
    
</table>



</div>

<div id="header-bound">
This model is open source, view the source code and learn how it works on github: <a href="https://github.com/TrystanLea/energymodel/tree/model3">https://github.com/TrystanLea/energymodel/tree/model3</a>.
Comment on the model and see what further development is planned <a href="http://zcb.wikispot.org/OpensourceEnergyModel">here</a>.
You can also download the full ten year hourly model used for ZCB <a href="https://dl.dropboxusercontent.com/u/79311585/ZCB_TYHME_v2.xlsx">here</a>.
</div>

</body>

<script>

    var csvfile = "";

    // ------------------------------
    // Module control
    // ------------------------------
    var useH2ForSynthFuels = 1;
    

    // ------------------------------
    // Supply
    // ------------------------------

    // Supply capacities
    var onshore_wind_capacity = 20;         // GW
    var offshore_wind_capacity = 140;       // GW
    var solar_capacity = 70;                // GW
    var hydroCap = 3;                       // GW
    var wave_capacity = 10;                 // GW
    var tidal_capacity = 20;                // GW
    var nuclear_capacity = 0;               // GW
    var backupCap = 45;                     // GW
    var total_biomass_produced = 274;       // TWh/yr
    var biomass_available = total_biomass_produced*1000;
    
    var solarthermal_capacity = 30;
    var geothermal_heat_capacity = 2;

    // accumulated totals for UI stats
    var onshore_wind_generation_total = 0;
    var offshore_wind_generation_total = 0;
    var solar_generation_total = 0;
    var hydro_generation_total = 0;
    var wave_generation_total = 0;
    var tidal_generation_total = 0;
    var nuclear_generation_total = 0;
    var backupGeneration = 0;
    var backupCapUsed = 0;
    
    var total_liquid_produced = 0;
    var total_gas_produced = 0;
    
    // hourly for graph's
    var onshore_wind_power = [];
    var offshore_wind_power = [];
    var solar_power = [];
    var wave_power = [];
    var tidal_power = [];
    var totalGeneration = [];
    var backupUsed = [];
    var CHPPower = [];

    var excess_electricity_generation = 0;

    var totalGenerationWithStorage = [];
    // ------------------------------
    // Demand
    // ------------------------------
    
    var hourly_unmet_demand = [];
    
    var energyDemand = [];
    var hourlyElecForAppliances = [];
    var hourlyHeatDemand = [];
    var hourlyElecForHeatDemand = [];
    var hourlySpaceHeatDemand = [];
    var hourlyWaterHeatDemand = [];
    var hourlyElecForIndustry = [];
    var temperatureData = [];

    // accumulated totals
    var total_hydrogen_demand = 0;
    var total_solid_demand = 0;
    var total_gas_demand = 0;
    var total_liquid_demand = 0;
    
    var unmet_electricity_demand = 0;
    var unmet_hydrogen_demand = 0;
    var unmet_solid_demand = 0;
    var unmet_liquid_demand = 0;
    var unmet_gas_demand = 0;
    
    var hydrogen_final_balance = 0;
    var methane_final_balance = 0;
    
    var totalDemandInProfile = 307111.8;        // FROM CSV!!!!
    
    var number_of_buildings = 32;
    var average_heatloss_WK = 135;
    var heatLossCoefficient = (number_of_buildings * 1000000 * average_heatloss_WK) / 1000000000; // 4.4; // GW/degC
    var baseTemp = 16-(385/((heatLossCoefficient/4.398)*119)); //Gains need linking to appliances energy reduction
    var hourly_heatpump_COP = 3.0;
    
    var totalHeatDemand = 0;
    var hotWaterDemand_TWh = 96;
    var percentHeatDirectelec = 10;
    var percentHeatHeatpumps = 85;
    var percentHeatSolid = 5;
    var percentHeatGas = 0;
    var percentHeatLiquid = 0;
    var percentHeatCHPSolid = 0;
    var percentHeatCHPGas = 0;
    var percentHeatCHPLiquid = 0;
    var appliancesDemand_TWh = 105;
    var appliancesSolidDemand = 0;
    var appliancesGasDemand = 0;
    var appliancesLiquidDemand = 0;

    var electrains_miles = 8000;
    var electrains_performance = 2.5;
    var electrains_passengers = 40;
    var electrains_energy_demand = ( (electrains_miles * 1.609/100) * electrains_performance * electrains_passengers * 1000000)/1000000000;
            
    var elecvehicles_miles_driven = 8000;
    var elecvehicles_miles_per_kwh = 4;
    var elecvehicles_number = 20;
    var elecvehicles_energy_demand = ((elecvehicles_miles_driven / elecvehicles_miles_per_kwh) * elecvehicles_number * 1000000)/1000000000;
    
    var transportDemand_TWh = elecvehicles_energy_demand + electrains_energy_demand; // 42
    var hourlyElecForTransportDemand = [];
    
    var hydrogenvehicles_miles_driven = 8000;
    var hydrogenvehicles_miles_per_kwh = 1.1;
    var hydrogenvehicles_number = 2;
    var hydrogenvehicles_H2_energy_demand = ((hydrogenvehicles_miles_driven / hydrogenvehicles_miles_per_kwh) * hydrogenvehicles_number * 1000000)/1000000000;
    
    var transportHydrogenDemand = hydrogenvehicles_H2_energy_demand;
    
    var other_transportLiquidDemand = 53.4;
    
    var biofuelaircraft_passengers = 40;
    var biofuelaircraft_miles = 1200;
    var biofuelaircraft_performance = 50;
    var biofuelaircraft_energy_demand = (((biofuelaircraft_miles*1.609/100)*biofuelaircraft_performance) * biofuelaircraft_passengers*1000000)/1000000000;

    var biofuelvehicles_number = 2;
    var biofuelvehicles_miles = 3000;
    var biofuelvehicles_miles_per_kwh = 1.0;
    var biofuelvehicles_energy_demand = ((biofuelvehicles_miles * biofuelvehicles_miles_per_kwh) * biofuelvehicles_number*1000000)/1000000000;
    
    var transportLiquidDemand = biofuelaircraft_energy_demand + biofuelvehicles_energy_demand + other_transportLiquidDemand;
    
    var transportSolidDemand = 0;
    var transportGasDemand = 0;
    

    var industryDemand_TWh = 171;
    var industrySolidDemand = 0;
    var industryGasDemand = 61;
    var industryLiquidDemand = 12;
    var industryCHPSolidDemand = 26;
    var industryCHPGasDemand = 0;
    var industryCHPLiquidDemand = 0;
    var industryHydrogenDemand = 0;
    
    var total_electricity_demand = 0;
    var total_electricity_generation = 0;
    var max_shortfall = 0
    
    var grid_loss = 0.07; // 7% - apply to supply from renewables (except PV & CHP), nuke & backup.
    
    //------------------------------------------------
    // Electric storage (in-home & grid scale) capacity, size, performance
    //------------------------------------------------
    var elecstore_max_discharge_rate   = 10;      // GW
    var elecstore_max_charge_rate      = 10;      // GW
    var elecstore_capacity             = 500;     // GWh
    var elecstore_discharge_efficiency = 0.9;      // 90%
    var elecstore_charge_efficiency    = 0.9;      // 90%
        
    // Variables to record utilisation of store
    var elecstore_used_discharge_rate = 0;
    var elecstore_used_charge_rate = 0;
    var elecstore_used_min_capacity = elecstore_capacity;
    var elecstore_used_max_capacity = 0;
    var elecstore_total_charge = 0;
    var elecstore_total_discharge = 0;
    var elecstore_total_loss = 0;

    var elecstore_hourly_capacity = [];
    var elecstore_start_capacity = elecstore_capacity / 2;
    var elecstore_SOC = elecstore_start_capacity;
    
    var hourly_elecstore_discharge = [];
    var hourly_elecstore_change = [];

    // ------------------------------
    // Hydrogen + synthetic fuels
    // ------------------------------
    var electrolysisCap = 35;
    var hourly_electrolysis_demand = [];
    var total_hydrogen_produced = 0;
    
    var hydrogen_store_capacity = 2000;
    var hydrogen_store_SOC = hydrogen_store_capacity / 2;
    var hydrogen_store_SOC_hourly = [];
    
    var synthfuel_store_capacity = 2000;
    var synthfuel_store_SOC = synthfuel_store_capacity / 2;
    var synthfuel_store_SOC_hourly = [];
    
    var methane_store_capacity = 10000;
    var methane_store_SOC = methane_store_capacity / 2;
    var methane_store_SOC_hourly = [];
    // ------------------------------    
    
    var spaceHeatingDailyProfile = [0.8,0.8,0.9,0.9,1.7,6.5,7.7,8.3,7.5,6.0,4.6,4.0,3.5,3.3,3.3,3.4,3.7,4.1,5.2,6.3,6.4,6.1,4.2,0.8];   // percent adds up to 100
    var hotWaterDailyProfile = [4.1,4.1,4.1,4.1,4.1,4.1,4.1,4.1,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2];
    // [0.1,0.1,0.1,0.5,1.5,3.5,7.6,10.2,11.2,6.9,4.6,3.0,1.9,1.9,2.1,3.0,7.0,7.8,7.1,5.8,4.5,3.7,3.2,2.7];
    var industrialDailyProfile = [4.1,4.1,4.1,4.1,4.1,4.1,4.1,4.1,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2,4.2];
    // [1,1,1,1,1,1,1,1,10.5,10.5,10.5,10.5,10.5,10.5,10.5,10.5,1,1,1,1,1,1,1,1];

    var electrains_use_profile = [0.0042682926, 0.0024390243, 0.0018292682, 0.0012195122, 0.0036585365, 0.0097560973, 0.0256097554, 0.0615853642, 0.0548780473, 0.0487804865, 0.0585365838, 0.0664634128, 0.0731707297, 0.0658536568, 0.0731707297, 0.0823170709, 0.0774390223, 0.0792682905, 0.0670731689, 0.0512195108, 0.0384146331, 0.0280487797, 0.0158536581, 0.0091463412];
    var BEV_charge_profile = [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.05, 0.05, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.05, 0.05, 0.05, 0.05, 0.1];
    
    var graph_mode = 'balance';
    
    $("[key]").each(function(){
        var keyparts = $(this).attr('key').split(".");
        if (keyparts[0]=='input') $(this).val(window[keyparts[1]]);
    });
    function process()
    {
        $("[key]").each(function(){
            var keyparts = $(this).attr('key').split(".");
            if (keyparts[0]=='input') window[keyparts[1]] = parseFloat($(this).val());
        });
                
        // Variable reset        
        
        // ------------------------------
        // Supply
        // ------------------------------

        // accumulated totals for UI stats
        onshore_wind_generation_total = 0;
        offshore_wind_generation_total = 0;
        solar_generation_total = 0;
        hydro_generation_total = 0;
        wave_generation_total = 0;
        tidal_generation_total = 0;
        nuclear_generation_total = 0;
        backupGeneration = 0;
        backupCapUsed = 0;
        
        biomass_available = total_biomass_produced*1000;
        total_liquid_produced = 0;
        total_gas_produced = 0;
        
        excess_electricity_generation = 0;
        total_electricity_generation = 0;

        // ------------------------------
        // Demand
        // ------------------------------
        heatLossCoefficient = (number_of_buildings * 1000000 * average_heatloss_WK) / 1000000000; // 4.4; // GW/degC
        
        baseTemp = 16-(385/((heatLossCoefficient/4.398)*119)); //Gains need linking to appliances energy reduction
        annual_hotwater_demand = hotWaterDemand_TWh*1000;
        average_heatpump_COP = 0;
        
        electrains_energy_demand = ((electrains_miles * 1.609 / 100)* electrains_performance * electrains_passengers * 1000000)/1000000000;
        elecvehicles_energy_demand = ((elecvehicles_miles_driven / elecvehicles_miles_per_kwh) * elecvehicles_number * 1000000)/1000000000;
        
        hydrogenvehicles_H2_energy_demand = ((hydrogenvehicles_miles_driven / hydrogenvehicles_miles_per_kwh) * hydrogenvehicles_number * 1000000)/1000000000;
        transportHydrogenDemand = hydrogenvehicles_H2_energy_demand;
        
        biofuelaircraft_energy_demand = (((biofuelaircraft_miles*1.609/100)*biofuelaircraft_performance) * biofuelaircraft_passengers*1000000)/1000000000;
        biofuelvehicles_energy_demand = ((biofuelvehicles_miles * biofuelvehicles_miles_per_kwh) * biofuelvehicles_number*1000000)/1000000000;
        transportLiquidDemand = biofuelaircraft_energy_demand + biofuelvehicles_energy_demand + other_transportLiquidDemand;
        
        industryDemand = industryDemand_TWh*1000;
        
        // accumulated totals
        total_electricity_demand = 0;
        total_hydrogen_demand = 0;
        total_solid_demand = 0;
        total_gas_demand = 0;
        total_liquid_demand = 0;
        
        unmet_electricity_demand = 0;
        unmet_hydrogen_demand = 0;
        unmet_solid_demand = 0;
        unmet_liquid_demand = 0;
        unmet_gas_demand = 0;

        totalHeatDemand = 0;
        
        max_shortfall = 0
        
        // ------------------------------
        // Electric storage
        // ------------------------------
        elecstore_used_discharge_rate = 0;
        elecstore_used_charge_rate = 0;
        elecstore_used_min_capacity = elecstore_capacity;
        elecstore_used_max_capacity = 0;
        elecstore_total_charge = 0;
        elecstore_total_discharge = 0;
        elecstore_total_loss = 0;

        elecstore_start_capacity = elecstore_capacity / 2;
        elecstore_SOC = elecstore_start_capacity;

        // ------------------------------
        // Hydrogen + synthetic fuels
        // ------------------------------
        total_hydrogen_produced = 0;
        
        hydrogen_store_SOC = hydrogen_store_capacity / 2;
        synthfuel_store_SOC = synthfuel_store_capacity / 2;
        methane_store_SOC = methane_store_capacity / 2;
        
        min_cop = 10000;
        max_cop = -10000;
       
        hour=0;
        var lines = csvfile.split(/\r\n|\n/);
        for (var i=0; i<8760; i++) {
        
            var splitarray = lines[i].split(',');  

            // ------------------------------------------------------------------------------------------------------
            //                                             START OF MODEL
            // ------------------------------------------------------------------------------------------------------
            // Model contents:
            // - variable supply
            // - demand
            // - heatstore                  todo
            // - electric transport         todo
            // - elecstore
            // - hydrogen production
            //   - biomethane production
            // - backup generation
            // - final balance
            // 
            // Demand types:
            // - electricity
            // - gas: methane
            // - liquid: synthetic fuel
            // - solid: biomass
            
            // The model starts by calculating energy demand for:
            // - appliances
            // - heating
            // - transport
            
            // ------------------------------------------------------------------------------------------------------
            // SUPPLY
            // ------------------------------------------------------------------------------------------------------            
            onshore_wind_power[i] = parseFloat(splitarray[1]) * onshore_wind_capacity * 0.9;
            offshore_wind_power[i] = parseFloat(splitarray[2]) * offshore_wind_capacity * 0.9;
            wave_power[i] = parseFloat(splitarray[3]) * wave_capacity;
            tidal_power[i] = parseFloat(splitarray[4]) * tidal_capacity;
            
            var solar_hourly = parseFloat(splitarray[5]);
            solar_power[i] = solar_hourly * solar_capacity;
            temperatureData[i] = parseFloat(splitarray[6]);
            
            onshore_wind_generation_total += onshore_wind_power[i];
            offshore_wind_generation_total += offshore_wind_power[i];
            wave_generation_total += wave_power[i];
            tidal_generation_total += tidal_power[i];
            solar_generation_total += solar_power[i];
            hydro_generation_total += hydroCap*0.3;
            nuclear_generation_total += nuclear_capacity*0.9;

            // ------------------------------------------------------------------------------------------------------
            // DEMAND
            // ------------------------------------------------------------------------------------------------------
            var traditional_electricity_demand_profile = parseFloat(splitarray[0]) / totalDemandInProfile;
            
            // ------------------------------------------------------------------------------------------------------
            // SPACE & WATER HEATING DEMAND
            // ------------------------------------------------------------------------------------------------------
            var solarthermal_supply = solarthermal_capacity * solar_hourly;
            var geothermal_heat_supply = geothermal_heat_capacity * 0.9;
            
            var deltaT = baseTemp - temperatureData[i];
            if (deltaT<0) deltaT = 0;
            var daily_heat_demand = (deltaT * heatLossCoefficient) * 24;
            
            hourlySpaceHeatDemand[i] = daily_heat_demand * spaceHeatingDailyProfile[hour] / 100;

            // profiles are in percent of daily heating demand (0-100), / 100 converts to 0-1;
            // demand is in GWh per year so we need to divide by 365 to obtain GWh per day
            hourlyWaterHeatDemand[i] = (annual_hotwater_demand/365.0) * (hotWaterDailyProfile[hour]/100);
            hourlyHeatDemand[i] = hourlySpaceHeatDemand[i] + hourlyWaterHeatDemand[i] - solarthermal_supply - geothermal_heat_supply;
            if (hourlyHeatDemand[i]<0) hourlyHeatDemand[i] = 0;
            totalHeatDemand += hourlyHeatDemand[i];
            
            // Heatstore here...
            
            // var T_condensing = baseTemp + 8;
            // var T_evaporating = temperatureData[i] - 6;
            // hourly_heatpump_COP = ((T_condensing + 273) / ((T_condensing+273) - (T_evaporating + 273))) * 0.1;
            // if (hourly_heatpump_COP<1) hourly_heatpump_COP = 1;
            
            // var hourly_heatpump_COP = 4.0 - deltaT * 0.2;
            // if (hourly_heatpump_COP<1) hourly_heatpump_COP = 1;
            
            
            average_heatpump_COP += hourly_heatpump_COP;
            if (hourly_heatpump_COP<min_cop) min_cop = hourly_heatpump_COP; 
            if (hourly_heatpump_COP>max_cop) max_cop = hourly_heatpump_COP; 
            
            hourlyElecForHeatDemand[i] = (hourlyHeatDemand[i] * (percentHeatHeatpumps / 100.0) / hourly_heatpump_COP) + (hourlyHeatDemand[i] * percentHeatDirectelec / 100);
            
            // Calculate demand for solid, gas & liquid fuel for heat
            var solid_for_heat = (hourlyHeatDemand[i]*(percentHeatSolid/100))/0.9;
            var gas_for_heat = (hourlyHeatDemand[i]*(percentHeatGas/100))/0.9;
            var liquid_for_heat = (hourlyHeatDemand[i]*(percentHeatLiquid/100))/0.9;
              
            solid_for_heat += (hourlyHeatDemand[i]*(percentHeatCHPSolid/100))/0.6;
            gas_for_heat += (hourlyHeatDemand[i]*(percentHeatCHPGas/100))/0.6;
            liquid_for_heat += (hourlyHeatDemand[i]*(percentHeatCHPLiquid/100))/0.6;
            
            // CHP assumes efficiency of 30% for electricity, 60% for heat
            CHPPower[i] = (hourlyHeatDemand[i]*(percentHeatCHPSolid/100))*(0.3/0.6) + 
                      (hourlyHeatDemand[i]*(percentHeatCHPGas/100))*(0.3/0.6) + 
                      (hourlyHeatDemand[i]*(percentHeatCHPLiquid/100))*(0.3/0.6) + 
                      ((industryCHPSolidDemand/8760)*1000 * 24 * (industrialDailyProfile[hour]/100))*0.3 + 
                      ((industryCHPGasDemand/8760)*1000 * 24 * (industrialDailyProfile[hour]/100))*0.3 +
                      ((industryCHPLiquidDemand/8760)*1000 * 24 * (industrialDailyProfile[hour]/100))*0.3 ;
            

            hourlyElecForAppliances[i] = traditional_electricity_demand_profile * (appliancesDemand_TWh*1000);
            hourlyElecForIndustry[i] = (industryDemand/365.0) * (industrialDailyProfile[hour]/100);
            
            // Electric transport
            var electric_train_demand = electrains_use_profile[hour] * (electrains_energy_demand/365.0*1000);
            var electric_car_dumb_charge = BEV_charge_profile[hour] * (elecvehicles_energy_demand/365.0*1000);
            
            hourlyElecForTransportDemand[i] = electric_train_demand + electric_car_dumb_charge;
            
            energyDemand[i] = hourlyElecForAppliances[i] + hourlyElecForHeatDemand[i] + hourlyElecForTransportDemand[i] + hourlyElecForIndustry[i];
            totalGeneration[i] = onshore_wind_power[i] + offshore_wind_power[i] + solar_power[i] + hydroCap*0.3 + wave_power[i] + tidal_power[i] + (nuclear_capacity*0.9) + CHPPower[i];
           
            // variables used for graph.
            total_electricity_demand += energyDemand[i];
            total_electricity_generation += totalGeneration[i];
            
            // supplied after grid losses
            totalGeneration[i] = (onshore_wind_power[i] + offshore_wind_power[i] + hydroCap*0.3
                    + wave_power[i] + tidal_power[i] + (nuclear_capacity*0.9))*(1-grid_loss) + solar_power[i] + CHPPower[i];
            
            // ------------------------------------------------------------------------------------------------------
            // 1) Initial electricity balance
            // ------------------------------------------------------------------------------------------------------
            var balance = totalGeneration[i] - energyDemand[i];
            
            // Add here:
            // Heat store
            // Electric transport
            
            // ------------------------------------------------------------------------------------------------------
            // ELECTRICITY STORE
            // ------------------------------------------------------------------------------------------------------
            hourly_elecstore_change[i] = 0;
            
            var elecstore_demand = 0;
            var elecstore_capacity_remaining = elecstore_capacity - elecstore_SOC;

            if (balance>0)
            {
                // STORE CHARGING
                //            Loss
                //             ^
                //             |
                // Surplus -l1---l2-> Store 
                //         
                // - l1 Rate limit
                // - l2 Capacity limit

                // Supply exceed's demand, excess energy fed into store
                var surplus_available = balance;
                
                //------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                var elecstore_charge_rate_pre_loss = surplus_available;
                if (elecstore_charge_rate_pre_loss>elecstore_max_charge_rate) elecstore_charge_rate_pre_loss = elecstore_max_charge_rate;           // 1. Charge rate limit
                var elecstore_charge_rate_after_loss = elecstore_charge_rate_pre_loss * elecstore_charge_efficiency;                            // 2. Calculate charge rate after losses
                if (elecstore_charge_rate_after_loss>elecstore_capacity_remaining) elecstore_charge_rate_after_loss = elecstore_capacity_remaining; // 3. Capacity limit
                elecstore_charge_rate_pre_loss = elecstore_charge_rate_after_loss / elecstore_charge_efficiency;                                // 4. Work backwards to obtain pre loss charge rate again
                var elecstore_loss = elecstore_charge_rate_pre_loss - elecstore_charge_rate_after_loss;                                         // 5. Calculate energy lost in charging
                elecstore_SOC += elecstore_charge_rate_after_loss;                                                                // 6. Calculate new store capacity level
     
     
                elecstore_total_charge += elecstore_charge_rate_pre_loss;
                hourly_elecstore_change[i] = elecstore_charge_rate_pre_loss*-1;
                hourly_elecstore_discharge[i] = 0;
                if (elecstore_charge_rate_pre_loss > elecstore_used_charge_rate) 
                    elecstore_used_charge_rate = elecstore_charge_rate_pre_loss;
                
                elecstore_total_loss += elecstore_loss;
                elecstore_demand = elecstore_charge_rate_pre_loss;
            }
            else
            {
                // STORE DISCHARGE
                //            Loss
                //             ^
                //             |
                // Store -l2------l1-> Output 
                //         
                // - l1 Rate limit
                // - l2 Capacity limit
            
                var shortfall = -balance;

                //------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                var elecstore_discharge_rate_after_loss = shortfall;
                if (elecstore_discharge_rate_after_loss>elecstore_max_discharge_rate) elecstore_discharge_rate_after_loss = elecstore_max_discharge_rate;   // 1. Discharge rate limit
                var elecstore_discharge_rate_pre_loss = elecstore_discharge_rate_after_loss / elecstore_discharge_efficiency;                           // 2. Calculate discharge rate pre losses
                if (elecstore_discharge_rate_pre_loss > elecstore_SOC) elecstore_discharge_rate_pre_loss = elecstore_SOC;                 // 3. Empty store limit
                elecstore_discharge_rate_after_loss = elecstore_discharge_rate_pre_loss * elecstore_discharge_efficiency;                               // 4. Work backwards to obtain after loss charge rate again
                var elecstore_loss = elecstore_discharge_rate_pre_loss - elecstore_discharge_rate_after_loss;                                           // 5. Calculate energy lost in charging
                elecstore_SOC -= elecstore_discharge_rate_pre_loss;                                                                       // 6. Calculate new store capacity level
                
                elecstore_total_discharge += elecstore_discharge_rate_after_loss;
                hourly_elecstore_change[i] += elecstore_discharge_rate_pre_loss;
                hourly_elecstore_discharge[i] = elecstore_discharge_rate_after_loss;
                if (elecstore_discharge_rate_after_loss > elecstore_used_discharge_rate) 
                    elecstore_used_discharge_rate = elecstore_discharge_rate_after_loss;
                
                elecstore_total_loss += elecstore_loss; // global scope!!
                
                elecstore_demand = -elecstore_discharge_rate_after_loss;
            }
            
            // ------------------------------------------------------------------------------------------------------
            // ELECTRICITY BALANCE: AFTER ELEC STORE
            // ------------------------------------------------------------------------------------------------------
            balance -= elecstore_demand;                             // elecstore_demand is negative when discharging
            
            // ------------------------------------------------------------------------------------------------------
            // DIRECT SOLID BIOMASS DEMAND (priority before methane production)
            // ------------------------------------------------------------------------------------------------------
            var solid_demand = solid_for_heat;
            solid_demand += appliancesSolidDemand*1000/(24*365);
            solid_demand += transportSolidDemand*1000/(24*365);
            solid_demand += industrySolidDemand*1000/(24*365);
            solid_demand += industryCHPSolidDemand*1000/(24*365);
            
            total_solid_demand += solid_demand;
            
            if (biomass_available>solid_demand) {
                biomass_available -= solid_demand;
            } else {
                biomass_available = 0;
                unmet_solid_demand += solid_demand - biomass_available;
            }  
            
            // ------------------------------------------------------------------------------------------------------
            // HYDROGEN PRODUCTION
            // ------------------------------------------------------------------------------------------------------
            //
            // PARAMETERS
            // - electrolysisCap
            // - hydrogen_store_capacity
            //
            // THE INPUT VARIABLES FOR THIS SECTION ARE:
            // - balance
            // - hydrogen_demand
            // - hydrogen_store_SOC
            // - hydrogen_shortfall
            // 
            // THE OUTPUT VARIABLES ARE:
            // - electricity_for_electrolysis
            // - hydrogen_store_SOC
            // - hydrogen_shortfall
            
            var hydrogen_demand = 0;
            hydrogen_demand += transportHydrogenDemand*1000 / (365*24);
            hydrogen_demand += industryHydrogenDemand*1000 / (365*24);
            
            var hydrogen_produced = 0;
            var electricity_for_electrolysis = 0;
            var hydrogen_balance = -hydrogen_demand;
            total_hydrogen_demand += hydrogen_demand;
            
            if (balance>0) {
                // positive balance == surplus electricity
                electricity_for_electrolysis = balance;             // max available electricity for electrolysis
                
                if (electricity_for_electrolysis > electrolysisCap)     // is then limited by electrolysis capacity
                    electricity_for_electrolysis = electrolysisCap;
                    
                var hydrogen_produced = electricity_for_electrolysis * 0.7; // resulting in produced hydrogen
                
                // subtract hydrogen demand from production
                hydrogen_balance += hydrogen_produced;
                
                if (useH2ForSynthFuels) 
                {
                    // ------------------------------------------------------------------------------------------------------
                    // SYNTHETIC FUEL PRODUCTION FROM EXESS HYDROGEN
                    // ------------------------------------------------------------------------------------------------------
                    var H2_for_FT = 0;
                    
                    if (hydrogen_balance>0) {
                        var H2_for_FT = hydrogen_balance;
                        var biomass_for_FT = H2_for_FT / 0.5;
                        
                        if (biomass_for_FT > biomass_available)   // Limit by biomass available
                            biomass_for_FT = biomass_available;
                        
                        H2_for_FT = biomass_for_FT * 0.5;              // re-calculate H2 requirement after biomass limit
                        var synthfuel = biomass_for_FT * 0.8;          // for every 0.8 unit of synth fuel 1 unit of biomass is used (+0.5 unit of hydrogen)
                        
                        // Limit synthfuel production by synthfuel store
                        if (synthfuel_store_SOC + synthfuel > synthfuel_store_capacity) {
                            synthfuel = synthfuel_store_capacity - synthfuel_store_SOC;
                            biomass_for_FT = synthfuel/0.8;
                            H2_for_FT = biomass_for_FT * 0.5;
                        }  
                        synthfuel_store_SOC += synthfuel;
                        biomass_available -= biomass_for_FT;
                        total_liquid_produced += synthfuel;
                        total_solid_demand += biomass_for_FT;
                        total_hydrogen_demand += H2_for_FT;
                    }
                    hydrogen_balance -= H2_for_FT;
                                    
                    // ------------------------------------------------------------------------------------------------------
                    // BIOMETHANE PRODUCTION FROM EXESS HYDROGEN
                    // ------------------------------------------------------------------------------------------------------
                    var H2_for_sabatier = 0;
                    
                    if (hydrogen_balance>0) {
                        // Generate biomethane
                        var H2_for_sabatier = hydrogen_balance;
                        var biomass_for_sabatier = H2_for_sabatier / 0.5;
                        
                        if (biomass_for_sabatier > biomass_available)   // Limit by biomass available
                            biomass_for_sabatier = biomass_available;
                        
                        H2_for_sabatier = biomass_for_sabatier * 0.5;   // re-calculate H2 requirement after biomass limit
                        var biomethane = biomass_for_sabatier;          // for every 1 unit of biomethane 1 unit of biomass is used (+0.5 unit of hydrogen)
                        
                        // Limit biomethane production by biomethane store
                        if (methane_store_SOC + biomethane > methane_store_capacity) {
                            biomethane = methane_store_capacity - methane_store_SOC;
                            biomass_for_sabatier = biomethane;
                            H2_for_sabatier = biomass_for_sabatier * 0.5;
                        }  
                        methane_store_SOC += biomethane;
                        biomass_available -= biomass_for_sabatier;
                        total_gas_produced += biomethane;
                        total_solid_demand += biomass_for_sabatier;
                        total_hydrogen_demand += H2_for_sabatier;
                    }
                    hydrogen_balance -= H2_for_sabatier;
                }
            }
                
            hydrogen_store_SOC += hydrogen_balance;
            
            // if hydrogen_balance is negative and subtracting the required hydrogen 
            // from the hydrogen store results in negative SOC (virtual defecit) then the store is empty
            // and the defecit in hydrogen production is the extent of the overshoot.
            if (hydrogen_store_SOC<0) {
                unmet_hydrogen_demand += -1*hydrogen_store_SOC;
                hydrogen_store_SOC = 0; 
            }

            // if calculated hydrogen SOC is in exess of capacity
            // then we need to limit hydrogen production in this itteration
            // so as not to fill the store
            if (hydrogen_store_SOC>hydrogen_store_capacity) {
                var exess = hydrogen_store_SOC - hydrogen_store_capacity;       // 'virtual exess'
                hydrogen_produced -= exess;                                     // actual hydrogen produced
                electricity_for_electrolysis = hydrogen_produced / 0.7;         // actual electricity used
                hydrogen_store_SOC = hydrogen_store_capacity;                   // store is full
            }
            
            total_hydrogen_produced += hydrogen_produced;
            
            // ------------------------------------------------------------------------------------------------------
            // ELECTRICITY BALANCE: AFTER ELECTROLYSIS
            // ------------------------------------------------------------------------------------------------------
            
            balance -= electricity_for_electrolysis;
            energyDemand[i] += electricity_for_electrolysis;
            hourly_electrolysis_demand[i] = electricity_for_electrolysis;
            // ------------------------------------------------------------------------------------------------------
            // METHANE FROM ANAEROBIC DIGESTION
            // ------------------------------------------------------------------------------------------------------
            var biogas = 0;
            total_gas_produced += biogas;
            
            // ------------------------------------------------------------------------------------------------------
            // METHANE + LIQUID DEMAND
            // ------------------------------------------------------------------------------------------------------
            var gas_demand = gas_for_heat;
            gas_demand += appliancesGasDemand * 1000 / (365*24);
            gas_demand += transportGasDemand * 1000 / (365*24);
            gas_demand += industryGasDemand * 1000 / (365*24);
            gas_demand += industryCHPGasDemand * 1000 / (365*24);
            
            total_gas_demand += gas_demand;
                 
            if (methane_store_SOC > gas_demand) {
                methane_store_SOC -= gas_demand;
            } else {
                methane_store_SOC = 0;
                
                var gas_remainder = gas_demand - methane_store_SOC;
                // direct biomass to liquid 60% efficient
                var direct_biomass_used = gas_remainder/0.6;
                
                if (direct_biomass_used>biomass_available)
                    direct_biomass_used = biomass_available;
                    
                total_solid_demand += direct_biomass_used;
                biomass_available -= direct_biomass_used;
                
                var gas_produced = direct_biomass_used * 0.6;
                unmet_gas_demand += gas_demand - gas_produced;
            }

            var liquid_demand = liquid_for_heat;
            liquid_demand += appliancesLiquidDemand * 1000 / (365*24);
            liquid_demand += transportLiquidDemand * 1000 / (365*24);
            liquid_demand += industryLiquidDemand * 1000 / (365*24);
            liquid_demand += industryCHPLiquidDemand * 1000 / (365*24);
            
            total_liquid_demand += liquid_demand;
                 
            if (synthfuel_store_SOC > liquid_demand) {
                synthfuel_store_SOC -= liquid_demand;
            } else {
                synthfuel_store_SOC = 0;
                
                var liquid_remainder = liquid_demand - synthfuel_store_SOC;
                // direct biomass to liquid 50% efficient
                var direct_biomass_used = liquid_remainder/0.5;
                
                if (direct_biomass_used>biomass_available)
                    direct_biomass_used = biomass_available;
                    
                total_solid_demand += direct_biomass_used;
                biomass_available -= direct_biomass_used;
                
                var liquid_produced = direct_biomass_used * 0.5;
                unmet_liquid_demand += liquid_demand - liquid_produced;
            } 
            
            
            // ------------------------------------------------------------------------------------------------------
            // BACKUP GENERATION FROM METHANE
            // ------------------------------------------------------------------------------------------------------
            // INPUTS:
            // - balance
            // - methane_store_SOC
            //
            // OUTPUTS:
            // - backupgen_delivered
            //
            
            var backupgen_delivered = 0;
            var backupgen_before_gridloss = 0;
            
            if (balance<0) {
                backupgen_delivered = -balance;
                backupgen_before_gridloss = backupgen_delivered * (1+grid_loss);
                if (backupgen_before_gridloss > backupCap) backupgen_before_gridloss = backupCap;
                var backupgen_gas_demand = backupgen_before_gridloss / 0.5;
                
                // Limit to gas available in methane store
                if (backupgen_gas_demand > methane_store_SOC) {
                    backupgen_gas_demand = methane_store_SOC;
                    backupgen_before_gridloss = backupgen_gas_demand * 0.5;
                    backupgen_delivered = backupgen_before_gridloss / (1+grid_loss);
                }
                methane_store_SOC -= backupgen_gas_demand;
                total_gas_demand += backupgen_gas_demand;
                
                backupgen_before_gridloss = backupgen_gas_demand * 0.5;
                backupgen_delivered = backupgen_before_gridloss / (1+grid_loss);
            }

            // ------------------------------------------------------------------------------------------------------
            // ELECTRICITY BALANCE: AFTER BACKUP GENERATION
            // ------------------------------------------------------------------------------------------------------
            balance += backupgen_delivered;
            
            // ------------------------------------------------------------------------------------------------------
            // FINAL BALANCE: RECORD EXESS OR SHORTFALL
            // ------------------------------------------------------------------------------------------------------
            if (balance>0) {
                excess_electricity_generation += balance;
                shortfall = 0;
            } else {
                shortfall = -balance;
                unmet_electricity_demand += shortfall;                                                      // record unmet demand
                if (shortfall>max_shortfall) max_shortfall = shortfall;                        // record max shortfall
            }
            
            // ------------------------------------------------------------------------------------------------------
            //                                             END OF MODEL
            // ------------------------------------------------------------------------------------------------------
            
            totalGenerationWithStorage[i] = totalGeneration[i];
            if (elecstore_demand<0) {
                // when elecstore_demand is negative the elecstore is discharging and so adds to supply
                totalGenerationWithStorage[i] -= elecstore_demand;
            } else {
                energyDemand[i] += elecstore_demand;
            }
            
            if (elecstore_SOC > elecstore_used_max_capacity) elecstore_used_max_capacity = elecstore_SOC;
            if (elecstore_SOC < elecstore_used_min_capacity) elecstore_used_min_capacity = elecstore_SOC;
            elecstore_hourly_capacity[i] = elecstore_SOC;
            
            hydrogen_store_SOC_hourly[i] = hydrogen_store_SOC;
            methane_store_SOC_hourly[i] = methane_store_SOC;
            synthfuel_store_SOC_hourly[i] = synthfuel_store_SOC;
            
            backupUsed[i] = backupgen_before_gridloss;            // Backup capacity used
            backupGeneration += backupgen_before_gridloss;
            if (backupgen_before_gridloss > backupCapUsed) 
                backupCapUsed = backupgen_before_gridloss;        // Max backup capacity used
            
            hourly_unmet_demand[i] = shortfall;

            hour++;
            if(hour==23) hour=0;
        }
        
        // hydrogen_final_balance = hydrogen_store_SOC - (hydrogen_store_capacity / 2) - unmet_hydrogen_demand;
        // methane_final_balance = methane_store_SOC - (methane_store_capacity / 2) - unmet_gas_demand;
        // liquid_final_balance = synthfuel_store_SOC - unmet_liquid_demand;
        biomass_surplus = biomass_available;
        console.log(unmet_solid_demand+" "+unmet_gas_demand+" "+unmet_liquid_demand+" "+unmet_hydrogen_demand)
        
        residual_emissions = unmet_electricity_demand*0.5 + unmet_solid_demand*0.4 + unmet_gas_demand*0.2 + unmet_liquid_demand*0.3 + unmet_hydrogen_demand*0.2;
        
        //-------------------------------------------------------------------------------------------
        
        $("[key]").each(function(){
            var keyparts = $(this).attr('key').split(".");
            
            var dp = $(this).attr('dp');
            if (dp==undefined) dp = 5;
            var scale = $(this).attr('scale');
            if (scale==undefined) scale = 1;
            if (keyparts[0]=='out' && keyparts.length==2 && window[keyparts[1]]!=undefined) 
                $(this).html((window[keyparts[1]]*scale).toFixed(dp));
                
            if (keyparts[0]=='out' && keyparts.length==3 && window[keyparts[1]]!=undefined) 
                $(this).html((window[keyparts[1]][keyparts[2]]*scale).toFixed(dp));
        });
        
        draw_graph();
    }

    $(document).ready(function() {
        $.ajax({
            type: "GET",
            url: "textfile.csv",
            dataType: "text",
            success: function(data) {csvfile = data; process();}
         });
    });
    
    $(".run").click(function(){
        process();
    });
    
    $("#balance").click(function(){
        graph_mode = 'balance';
        draw_graph();
    });

    $("#supply").click(function(){
        graph_mode = 'supply';
        draw_graph();
    });
    
    $("#demand").click(function(){
        graph_mode = 'demand';
        draw_graph();
    });
    
    $("#store").click(function(){
        graph_mode = 'store';
        draw_graph();
    });
    
    function draw_graph()
    {
        var c = document.getElementById("graph");  
        var ctx = c.getContext("2d");
        var hr = 0; var day = 0; var week = 1;
        
        ctx.clearRect(0,0,8760,250);
        
        ctx.beginPath();
        ctx.strokeStyle = "#000";
        ctx.moveTo(25,5); ctx.lineTo(25, 225);
        ctx.moveTo(25,226); ctx.lineTo(8785, 226);
        ctx.fillText("Week",25,240);
        ctx.stroke();
        for(var p=1;p<8760;p++){
            if (day == 7){
                ctx.strokeRect(p+25,226,1, 2);
                ctx.fillText(week,p+25,240);
                day = 0;
                week++;
            }
            if(hr == 24) {day++; hr = 0;}
            hr++;
        }
        
        // Draw balance graph
        if(graph_mode == 'balance'){
        
            var level_colors = ["#00ff00","#ff0000"];
            var level_labels = ["Surplus of electricity","Shortfall of electricity"];
            
            ctx.strokeRect(23,25,1, 2);
            ctx.strokeRect(23,125,1, 2);
            ctx.fillText("GW",2,10);
            ctx.fillText("200",2,28);
            ctx.fillText("100",2,128);
            
            for (var i=0; i<2; i++)
            {
                ctx.fillStyle = level_colors[i];
                ctx.fillRect(40,i*15,10,10);
                ctx.strokeStyle = "#000";
                ctx.fillStyle = "#000";
                ctx.strokeRect(40,i*15,10,10);
                ctx.fillText(level_labels[i],60,10+i*15);
            }
            
            for(var p=1;p<8760;p++){
            
                ctx.beginPath();
                ctx.strokeStyle = "#0000ff";
                windSquarePos = Math.round(totalGenerationWithStorage[p-1]);
                windSquarePos1 = Math.round(totalGenerationWithStorage[p]);
                ctx.moveTo(p+26, 25+(200-windSquarePos1));
                ctx.lineTo(p+25, 25+(200-windSquarePos));
                ctx.stroke();
                
                ctx.beginPath();
                ctx.strokeStyle = "#000";
                demandSquarePos = Math.round(energyDemand[p-1]);
                demandSquarePos1 = Math.round(energyDemand[p]);
                ctx.moveTo(p+26, 25+(200-demandSquarePos1));
                ctx.lineTo(p+25, 25+(200-demandSquarePos));
                ctx.stroke();
                
                if(windSquarePos>demandSquarePos){
                    ctx.beginPath();
                    ctx.strokeStyle = "#00ff00";
                    ctx.moveTo(p+26, 25+(200-windSquarePos+1));
                    ctx.lineTo(p+25, 25+(200-demandSquarePos-1));
                    ctx.stroke();
                }
                else if(windSquarePos<demandSquarePos){
                
                    ctx.beginPath();
                    ctx.strokeStyle = "#ff0000";
                    ctx.moveTo(p+26, 25+(200-windSquarePos-1));
                    ctx.lineTo(p+25, 25+(200-demandSquarePos+1));
                    ctx.stroke();
                }
            }
        }
        //Draw supply graph 
        else if(graph_mode == 'supply'){

            var level_colors = ["#ff9900","#990099","#663300","#336666"];
            var level_labels = ["CHP","Nuclear","Hydro","Wave"];
            
            ctx.strokeRect(23,25,1, 2);
            ctx.strokeRect(23,125,1, 2);
            ctx.fillText("GW",2,10);
            ctx.fillText("200",2,28);
            ctx.fillText("100",2,128);
            
            for (var i=0; i<level_labels.length; i++)
            {
                ctx.fillStyle = level_colors[i];
                ctx.fillRect(40,i*15,10,10);
                ctx.strokeStyle = "#000";
                ctx.fillStyle = "#000";
                ctx.strokeRect(40,i*15,10,10);
                ctx.fillText(level_labels[i],60,10+i*15);
            }            
            level_colors = ["#33CC66","#f9e117","#0000FF","#00CCFF"];
            level_labels = ["Tidal","Solar","Offshore wind","Onshore wind"];
            
            for (var i=0; i<level_labels.length; i++)
            {
                ctx.fillStyle = level_colors[i];
                ctx.fillRect(100,i*15,10,10);
                ctx.strokeStyle = "#000";
                ctx.fillStyle = "#000";
                ctx.strokeRect(100,i*15,10,10);
                ctx.fillText(level_labels[i],120,10+i*15);
            }
            level_colors = ["#33ff00","#ff0000","#a9a9a9"];
            level_labels = ["Electric store","Back-up","Unmet"];
            
            for (var i=0; i<level_labels.length; i++)
            {
                ctx.fillStyle = level_colors[i];
                ctx.fillRect(200,i*15,10,10);
                ctx.strokeStyle = "#000";
                ctx.fillStyle = "#000";
                ctx.strokeRect(200,i*15,10,10);
                ctx.fillText(level_labels[i],220,10+i*15);
            }
        
            for(var p=1;p<8760;p++){ 
                
                ctx.strokeStyle = "#00ff00";
                onWindSquarePos = Math.round(onshore_wind_power[p-1]*(1-grid_loss));
                offWindSquarePos = Math.round(offshore_wind_power[p-1]*(1-grid_loss));
                solarPos = Math.round(solar_power[p-1]);
                wavePos = Math.round(wave_power[p-1]*(1-grid_loss));
                tidalPos = Math.round(tidal_power[p-1]*(1-grid_loss));
                CHPPos = Math.round(CHPPower[p-1]);
                hydroPos = Math.round((hydroCap * 0.3)*(1-grid_loss));
                nuclearPos = Math.round((nuclear_capacity * 0.9)*(1-grid_loss));
                storePos = Math.round(hourly_elecstore_discharge[p-1]);
                backupPos = Math.round(backupUsed[p-1]*(1-grid_loss));
                unmetPos = Math.round(hourly_unmet_demand[p-1]);
                
                ctx.strokeStyle = "#ff9900";  //orange
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-CHPPos));
                ctx.lineTo(p+25, 225);
                ctx.stroke();
                
                ctx.strokeStyle = "#990099"; //purple                  
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-CHPPos-nuclearPos));
                ctx.lineTo(p+25, 25+(200-CHPPos));
                ctx.stroke();
                
                ctx.strokeStyle = "#663300"; // Brown                   
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-CHPPos-nuclearPos-hydroPos));
                ctx.lineTo(p+25, 25+(200-CHPPos-nuclearPos));
                ctx.stroke();
                
                ctx.strokeStyle = "#336666"; //Aqua blue                  
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-CHPPos-nuclearPos-hydroPos-wavePos));
                ctx.lineTo(p+25, 25+(200-CHPPos-nuclearPos-hydroPos));
                ctx.stroke();
                
                ctx.strokeStyle = "#33CC66"; //Greeny blue                    
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-CHPPos-nuclearPos-hydroPos-wavePos-tidalPos));
                ctx.lineTo(p+25, 25+(200-CHPPos-nuclearPos-hydroPos-wavePos));
                ctx.stroke();
                               
                ctx.strokeStyle = "#f9e117";  //Yellow                  
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos);
                ctx.lineTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos);
                ctx.stroke();
                
                ctx.strokeStyle = "#0000FF"; //blue
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos-offWindSquarePos);
                ctx.lineTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos);
                ctx.stroke();
                
                ctx.strokeStyle = "#00CCFF"; //light blue
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos-offWindSquarePos-onWindSquarePos);
                ctx.lineTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos-offWindSquarePos);
                ctx.stroke();
                
                ctx.strokeStyle = "#33ff00"; //Green
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos-offWindSquarePos-onWindSquarePos-storePos);
                ctx.lineTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos-offWindSquarePos-onWindSquarePos);
                ctx.stroke();
                
                ctx.strokeStyle = "#ff0000"; // Red
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos-offWindSquarePos-onWindSquarePos-storePos-backupPos);
                ctx.lineTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos-offWindSquarePos-onWindSquarePos-storePos);
                ctx.stroke();
                
                ctx.strokeStyle = "#a9a9a9"; // grey
                ctx.beginPath();
                ctx.moveTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos-offWindSquarePos-onWindSquarePos-storePos-backupPos-unmetPos);
                ctx.lineTo(p+25, 25+(200-nuclearPos)-CHPPos-hydroPos-wavePos-tidalPos-solarPos-offWindSquarePos-onWindSquarePos-storePos-backupPos);
                ctx.stroke();
                              
            }
        } //Draw store graph 
        else if(graph_mode == 'store'){
        
            var maxallstores = elecstore_capacity + hydrogen_store_capacity + methane_store_capacity + synthfuel_store_capacity;
            var level_colors = ["#CCCCFF","#ffccff","#ffcc00","#ffee00"];
            var level_labels = ["Elecstore","Hydrogen","Liquid","Methane"];

            ctx.strokeRect(23,25,1, 2);
            ctx.strokeRect(23,125,1, 2);
            ctx.fillText("%",2,10);
            ctx.fillText("100",2,28);
            ctx.fillText("50",2,128);

            for (var i=0; i<level_labels.length; i++)
            {
                ctx.fillStyle = level_colors[i];
                ctx.fillRect(40,i*15,10,10);
                ctx.strokeStyle = "#000";
                ctx.fillStyle = "#000";
                ctx.strokeRect(40,i*15,10,10);
                ctx.fillText(level_labels[i],60,10+i*15);
            }
                        
            for(var p=1;p<8760;p++){
                var l = [];
                l[0] = elecstore_hourly_capacity[p-1];
                l[1] = l[0] + hydrogen_store_SOC_hourly[p-1];
                l[2] = l[1] + synthfuel_store_SOC_hourly[p-1];
                l[3] = l[2] + methane_store_SOC_hourly[p-1];
                
                // fill
                for (var i=0; i<l.length; i++)
                {
                    var posA = 0;
                    if (i>0) posA = (l[i-1]/maxallstores)*200;
                    var posB = (l[i]/maxallstores)*200;
                    ctx.strokeStyle = level_colors[i];
                    ctx.beginPath();
                    ctx.moveTo(p+25, 25+(200-posA));
                    ctx.lineTo(p+25, 25+(200-posB));
                    ctx.stroke();
                }                
                
                // black lines
                for (var i=0; i<l.length; i++)
                {
                    var pos = (l[i]/maxallstores)*200;
                    ctx.strokeStyle = "#000";
                    ctx.beginPath();
                    ctx.moveTo(p+25, 24+(200-pos));
                    ctx.lineTo(p+25, 26+(200-pos));
                    ctx.stroke();
                }
            }        
        } //Draw store graph 
        else if(graph_mode == 'demand'){

            var ymax = 200;
            var level_colors = ["#0000cc","#FF0000","#cccc00","#de2bf3","#CCCCFF","#FFCCFF"];
            var level_labels = ["Appliances","Heat","Transport","Industry","Elecstore charge", "Electrolysis"];
            
            ctx.strokeRect(23,25,1, 2);
            ctx.strokeRect(23,125,1, 2);
            ctx.fillText("GW",2,10);
            ctx.fillText("200",2,28);
            ctx.fillText("100",2,128);
            
            for (var i=0; i<3; i++)
            {
                ctx.fillStyle = level_colors[i];
                ctx.fillRect(40,i*15,10,10);
                ctx.strokeStyle = "#000";
                ctx.fillStyle = "#000";
                ctx.strokeRect(40,i*15,10,10);
                ctx.fillText(level_labels[i],60,10+i*15);
            }            
            for (var i=3; i<level_labels.length; i++)
            {
                ctx.fillStyle = level_colors[i];
                ctx.fillRect(120,(i-3)*15,10,10);
                ctx.strokeStyle = "#000";
                ctx.fillStyle = "#000";
                ctx.strokeRect(120,(i-3)*15,10,10);
                ctx.fillText(level_labels[i],140,10+(i-3)*15);
            }
            
            for(var p=1;p<8760;p++){
                var elecstore_charge = 0;
                if (hourly_elecstore_change[p-1]>0) elecstore_charge = hourly_elecstore_change[p-1];
                
                var l = [];                
                l[0] = hourlyElecForAppliances[p-1];
                l[1] = l[0] + hourlyElecForHeatDemand[p-1];
                l[2] = l[1] + hourlyElecForTransportDemand[p-1];
                l[3] = l[2] + hourlyElecForIndustry[p-1];
                l[4] = l[3] + elecstore_charge;
                l[5] = l[4] + hourly_electrolysis_demand[p-1];
                
                // fill
                for (var i=0; i<l.length; i++)
                {
                    var posA = 0;
                    if (i>0) posA = (l[i-1]/ymax)*200;
                    var posB = (l[i]/ymax)*200;
                    ctx.strokeStyle = level_colors[i];
                    ctx.beginPath();
                    ctx.moveTo(p+25, 25+(200-posA));
                    ctx.lineTo(p+25, 25+(200-posB));
                    ctx.stroke();
                }
            }        
        }
    }

</script>


